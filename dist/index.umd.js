!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("ra-realtime"),require("firebase/firestore"),require("rxjs"),require("firebase/app"),require("firebase/auth"),require("react-admin")):"function"==typeof define&&define.amd?define(["exports","ra-realtime","firebase/firestore","rxjs","firebase/app","firebase/auth","react-admin"],r):r(e.reactAdminFirebase={},e.realtimeSaga,0,e.rxjs,e.firebase,0,e.reactAdmin)}(this,function(e,r,t,n,i,o,a){function s(e,r){c&&console.log(e,r)}r=r&&r.hasOwnProperty("default")?r.default:r;var u,c=!1,p=function(e){this.resources={},this.app=i.apps.length?i.app():i.initializeApp(e),this.db=this.app.firestore()};function h(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}function f(e,r){l&&console.log("FirebaseAuthProvider: "+e,r)}p.prototype.parseFireStoreDocument=function(e){var r=e.data();return Object.keys(r).forEach(function(e){var t=r[e];t&&t.toDate&&t.toDate instanceof Function&&(r[e]=t.toDate().toISOString())}),Object.assign({},{id:e.id},r)},p.prototype.initPath=function(e){try{var r=this;return new Promise(function(t){if(r.resources[e])return t();var n=r.db.collection(e),i=r.getCollectionObservable(n);i.subscribe(function(n){var i=n.docs.map(function(e){return r.parseFireStoreDocument(e)});r.setList(i,e),t()});var o={collection:n,list:[],observable:i,path:e};r.resources[e]=o,s("initPath",{path:e,r:o,"this.resources":r.resources})})}catch(e){return Promise.reject(e)}},p.prototype.apiGetList=function(e,r){try{var t=this;return Promise.resolve(t.tryGetResource(e)).then(function(n){var i=n.list;if(null!=r.sort){var o=r.sort;t.sortArray(i,o.field,"ASC"===o.order?"asc":"desc")}s("apiGetList",{resourceName:e,resource:n,params:r});var a=t.filterArray(i,r.filter),u=(r.pagination.page-1)*r.pagination.perPage;return{data:a.slice(u,u+r.pagination.perPage),total:n.list.length}})}catch(e){return Promise.reject(e)}},p.prototype.apiGetOne=function(e,r){try{return Promise.resolve(this.tryGetResource(e)).then(function(t){s("apiGetOne",{resourceName:e,resource:t,params:r});var n=t.list.filter(function(e){return e.id===r.id});if(n.length<1)throw new Error("react-admin-firebase: No id found matching: "+r.id);return{data:n.pop()}})}catch(e){return Promise.reject(e)}},p.prototype.apiCreate=function(e,r){try{return Promise.resolve(this.tryGetResource(e)).then(function(t){return s("apiCreate",{resourceName:e,resource:t,params:r}),Promise.resolve(t.collection.add(r.data)).then(function(e){return{data:Object.assign({},r.data,{id:e.id})}})})}catch(e){return Promise.reject(e)}},p.prototype.apiUpdate=function(e,r){try{var t=r.id;return delete r.data.id,Promise.resolve(this.tryGetResource(e)).then(function(n){return s("apiUpdate",{resourceName:e,resource:n,params:r}),n.collection.doc(t).update(r.data),{data:Object.assign({},r.data,{id:t})}})}catch(e){return Promise.reject(e)}},p.prototype.apiUpdateMany=function(e,r){try{return delete r.data.id,Promise.resolve(this.tryGetResource(e)).then(function(t){s("apiUpdateMany",{resourceName:e,resource:t,params:r});for(var n=[],i=0,o=r.ids;i<o.length;i+=1){var a=o[i];t.collection.doc(a).update(r.data),n.push(Object.assign({},r.data,{id:a}))}return{data:n}})}catch(e){return Promise.reject(e)}},p.prototype.apiDelete=function(e,r){try{return Promise.resolve(this.tryGetResource(e)).then(function(t){return s("apiDelete",{resourceName:e,resource:t,params:r}),t.collection.doc(r.id).delete(),{data:r.previousData}})}catch(e){return Promise.reject(e)}},p.prototype.apiDeleteMany=function(e,r){try{var t=this;return Promise.resolve(t.tryGetResource(e)).then(function(n){s("apiDeleteMany",{resourceName:e,resource:n,params:r});for(var i=[],o=t.db.batch(),a=0,u=r.ids;a<u.length;a+=1){var c=u[a];o.delete(n.collection.doc(c)),i.push({id:c})}return o.commit(),{data:i}})}catch(e){return Promise.reject(e)}},p.prototype.apiGetMany=function(e,r){try{return Promise.resolve(this.tryGetResource(e)).then(function(t){s("apiGetMany",{resourceName:e,resource:t,params:r});var n=new Set(r.ids);return{data:t.list.filter(function(e){return n.has(e.id)})}})}catch(e){return Promise.reject(e)}},p.prototype.apiGetManyReference=function(e,r){try{var t=this;return Promise.resolve(t.tryGetResource(e)).then(function(n){s("apiGetManyReference",{resourceName:e,resource:n,params:r});var i=n.list,o=r.target,a=r.id,u=i.filter(function(e){return e[o]===a});if(null!=r.sort){var c=r.sort;t.sortArray(i,c.field,"ASC"===c.order?"asc":"desc")}var p=(r.pagination.page-1)*r.pagination.perPage;return{data:u.slice(p,p+r.pagination.perPage),total:u.length}})}catch(e){return Promise.reject(e)}},p.prototype.GetResource=function(e){return this.tryGetResource(e)},p.prototype.sortArray=function(e,r,t){e.sort(function(e,n){var i=e[r]?e[r].toString().toLowerCase():"",o=n[r]?n[r].toString().toLowerCase():"";return i>o?"asc"===t?-1:1:i<o?"asc"===t?1:-1:0})},p.prototype.filterArray=function(e,r){if("{}"==JSON.stringify(r))return e;var t=Object.keys(r);return e.filter(function(e){return t.reduce(function(t,n){var i=r[n].toLowerCase(),o=e[n];if(null==o)return!1;var a=o.toLowerCase().includes(i);return t||a},!1)})},p.prototype.setList=function(e,r){try{return Promise.resolve(this.tryGetResource(r)).then(function(r){r.list=e})}catch(e){return Promise.reject(e)}},p.prototype.tryGetResource=function(e){var r=this.resources[e];if(!r)throw new Error('react-admin-firebase: Cant find resource: "'+e+'"');return r},p.prototype.getCollectionObservable=function(e){return n.Observable.create(function(r){return e.onSnapshot(r)})};var l=!1,d=function(e){f("Auth Client: initializing..."),this.app=i.apps.length?i.app():i.initializeApp(e),this.auth=i.auth()};d.prototype.HandleAuthLogin=function(e){try{var r=this,t=e.username,n=e.password;return h(function(){return Promise.resolve(r.auth.signInWithEmailAndPassword(t,n)).then(function(e){f("HandleAuthLogin: user sucessfully logged in",{user:e})})},function(){throw f("HandleAuthLogin: invalid credentials",{params:e}),new Error("Login error: invalid credentials")})}catch(e){return Promise.reject(e)}},d.prototype.HandleAuthLogout=function(e){try{return Promise.resolve(this.auth.signOut()).then(function(){})}catch(e){return Promise.reject(e)}},d.prototype.HandleAuthError=function(e){},d.prototype.HandleAuthCheck=function(e){try{var r=this,t=h(function(){return Promise.resolve(r.getUserLogin()).then(function(e){f("HandleAuthCheck: user is still logged in",{user:e})})},function(e){f("HandleAuthCheck: ",{e:e})});return t&&t.then?t.then(function(){}):void 0}catch(e){return Promise.reject(e)}},d.prototype.getUserLogin=function(){try{var e=this;return new Promise(function(r,t){e.auth.onAuthStateChanged(function(e){e?r(e):t("User not logged in")})})}catch(e){return Promise.reject(e)}},e.FirebaseRealTimeSaga=function(e,t){return r(function(e,r){return function(t,n,i){if((!r||!Array.isArray(r.watch)||r.watch.includes(n))&&!(r&&Array.isArray(r.dontwatch)&&r.dontwatch.includes(n)))return{subscribe:function(r){var o=u.GetResource(n).observable.subscribe(function(){e(t,n,i).then(function(e){return r.next(e)}).catch(function(e){return r.error(e)})});return{unsubscribe:function(){o.unsubscribe()}}}}}}(e,t))},e.FirebaseDataProvider=function(e){if(!e)throw new Error("Please pass the Firebase config.json object to the FirebaseDataProvider");return c=e.debug,u=new p(e),function(e,r,t){try{return Promise.resolve(u.initPath(r)).then(function(){switch(e){case a.GET_MANY:return u.apiGetMany(r,t);case a.GET_MANY_REFERENCE:return u.apiGetManyReference(r,t);case a.GET_LIST:return u.apiGetList(r,t);case a.GET_ONE:return u.apiGetOne(r,t);case a.CREATE:return u.apiCreate(r,t);case a.UPDATE:return u.apiUpdate(r,t);case a.UPDATE_MANY:return u.apiUpdateMany(r,t);case a.DELETE:return u.apiDelete(r,t);case a.DELETE_MANY:return u.apiDeleteMany(r,t);default:return{}}})}catch(e){return Promise.reject(e)}}},e.FirebaseAuthProvider=function(e){if(!e)throw new Error("Please pass the Firebase config.json object to the FirebaseAuthProvider");l=e.debug;var r=new d(e);return function(e,t){try{switch(f("Auth Event: ",{type:e,params:t}),e){case a.AUTH_LOGIN:return Promise.resolve(r.HandleAuthLogin(t)).then(function(){});case a.AUTH_LOGOUT:return Promise.resolve(r.HandleAuthLogout(t)).then(function(){});case a.AUTH_ERROR:return Promise.resolve(r.HandleAuthError(t)).then(function(){});case a.AUTH_CHECK:return Promise.resolve(r.HandleAuthCheck(t)).then(function(){});default:throw new Error("Unhandled auth type:"+e)}}catch(e){return Promise.reject(e)}}}});
//# sourceMappingURL=index.umd.js.map
