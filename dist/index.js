var e,r=(e=require("ra-realtime"))&&"object"==typeof e&&"default"in e?e.default:e;require("firebase/firestore");var t=require("rxjs"),n=require("firebase/app");require("firebase/auth");var o=require("react-admin");function i(e,r){s&&console.log(e,r)}var a,s=!1,u=function(e){this.resources={},this.app=n.apps.length?n.app():n.initializeApp(e),this.db=this.app.firestore()};function c(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}function p(e,r){h&&console.log("FirebaseAuthProvider: "+e,r)}u.prototype.parseFireStoreDocument=function(e){var r=e.data();return Object.keys(r).forEach(function(e){var t=r[e];t&&t.toDate&&t.toDate instanceof Function&&(r[e]=t.toDate().toISOString())}),Object.assign({},{id:e.id},r)},u.prototype.initPath=function(e){try{var r=this;return new Promise(function(t){if(r.resources[e])return t();var n=r.db.collection(e),o=r.getCollectionObservable(n);o.subscribe(function(n){var o=n.docs.map(function(e){return r.parseFireStoreDocument(e)});r.setList(o,e),t()});var a={collection:n,list:[],observable:o,path:e};r.resources[e]=a,i("initPath",{path:e,r:a,"this.resources":r.resources})})}catch(e){return Promise.reject(e)}},u.prototype.apiGetList=function(e,r){try{var t=this;return Promise.resolve(t.tryGetResource(e)).then(function(n){var o=n.list;if(null!=r.sort){var a=r.sort;t.sortArray(o,a.field,"ASC"===a.order?"asc":"desc")}i("apiGetList",{resourceName:e,resource:n,params:r});var s=t.filterArray(o,r.filter),u=(r.pagination.page-1)*r.pagination.perPage;return{data:s.slice(u,u+r.pagination.perPage),total:n.list.length}})}catch(e){return Promise.reject(e)}},u.prototype.apiGetOne=function(e,r){try{return Promise.resolve(this.tryGetResource(e)).then(function(t){i("apiGetOne",{resourceName:e,resource:t,params:r});var n=t.list.filter(function(e){return e.id===r.id});if(n.length<1)throw new Error("react-admin-firebase: No id found matching: "+r.id);return{data:n.pop()}})}catch(e){return Promise.reject(e)}},u.prototype.apiCreate=function(e,r){try{return Promise.resolve(this.tryGetResource(e)).then(function(t){return i("apiCreate",{resourceName:e,resource:t,params:r}),Promise.resolve(t.collection.add(r.data)).then(function(e){return{data:Object.assign({},r.data,{id:e.id})}})})}catch(e){return Promise.reject(e)}},u.prototype.apiUpdate=function(e,r){try{var t=r.id;return delete r.data.id,Promise.resolve(this.tryGetResource(e)).then(function(n){return i("apiUpdate",{resourceName:e,resource:n,params:r}),n.collection.doc(t).update(r.data),{data:Object.assign({},r.data,{id:t})}})}catch(e){return Promise.reject(e)}},u.prototype.apiUpdateMany=function(e,r){try{return delete r.data.id,Promise.resolve(this.tryGetResource(e)).then(function(t){i("apiUpdateMany",{resourceName:e,resource:t,params:r});for(var n=[],o=0,a=r.ids;o<a.length;o+=1){var s=a[o];t.collection.doc(s).update(r.data),n.push(Object.assign({},r.data,{id:s}))}return{data:n}})}catch(e){return Promise.reject(e)}},u.prototype.apiDelete=function(e,r){try{return Promise.resolve(this.tryGetResource(e)).then(function(t){return i("apiDelete",{resourceName:e,resource:t,params:r}),t.collection.doc(r.id).delete(),{data:r.previousData}})}catch(e){return Promise.reject(e)}},u.prototype.apiDeleteMany=function(e,r){try{var t=this;return Promise.resolve(t.tryGetResource(e)).then(function(n){i("apiDeleteMany",{resourceName:e,resource:n,params:r});for(var o=[],a=t.db.batch(),s=0,u=r.ids;s<u.length;s+=1){var c=u[s];a.delete(n.collection.doc(c)),o.push({id:c})}return a.commit(),{data:o}})}catch(e){return Promise.reject(e)}},u.prototype.apiGetMany=function(e,r){try{return Promise.resolve(this.tryGetResource(e)).then(function(t){i("apiGetMany",{resourceName:e,resource:t,params:r});var n=new Set(r.ids);return{data:t.list.filter(function(e){return n.has(e.id)})}})}catch(e){return Promise.reject(e)}},u.prototype.apiGetManyReference=function(e,r){try{var t=this;return Promise.resolve(t.tryGetResource(e)).then(function(n){i("apiGetManyReference",{resourceName:e,resource:n,params:r});var o=n.list,a=r.target,s=r.id,u=o.filter(function(e){return e[a]===s});if(null!=r.sort){var c=r.sort;t.sortArray(o,c.field,"ASC"===c.order?"asc":"desc")}var p=(r.pagination.page-1)*r.pagination.perPage;return{data:u.slice(p,p+r.pagination.perPage),total:u.length}})}catch(e){return Promise.reject(e)}},u.prototype.GetResource=function(e){return this.tryGetResource(e)},u.prototype.sortArray=function(e,r,t){e.sort(function(e,n){var o=e[r]?e[r].toString().toLowerCase():"",i=n[r]?n[r].toString().toLowerCase():"";return o>i?"asc"===t?-1:1:o<i?"asc"===t?1:-1:0})},u.prototype.filterArray=function(e,r){if("{}"==JSON.stringify(r))return e;var t=Object.keys(r);return e.filter(function(e){return t.reduce(function(t,n){var o=r[n].toLowerCase(),i=e[n];if(null==i)return!1;var a=i.toLowerCase().includes(o);return t||a},!1)})},u.prototype.setList=function(e,r){try{return Promise.resolve(this.tryGetResource(r)).then(function(r){r.list=e})}catch(e){return Promise.reject(e)}},u.prototype.tryGetResource=function(e){var r=this.resources[e];if(!r)throw new Error('react-admin-firebase: Cant find resource: "'+e+'"');return r},u.prototype.getCollectionObservable=function(e){return t.Observable.create(function(r){return e.onSnapshot(r)})};var h=!1,l=function(e){p("Auth Client: initializing..."),this.app=n.apps.length?n.app():n.initializeApp(e),this.auth=n.auth()};l.prototype.HandleAuthLogin=function(e){try{var r=this,t=e.username,n=e.password;return c(function(){return Promise.resolve(r.auth.signInWithEmailAndPassword(t,n)).then(function(e){p("HandleAuthLogin: user sucessfully logged in",{user:e})})},function(){throw p("HandleAuthLogin: invalid credentials",{params:e}),new Error("Login error: invalid credentials")})}catch(e){return Promise.reject(e)}},l.prototype.HandleAuthLogout=function(e){try{return Promise.resolve(this.auth.signOut()).then(function(){})}catch(e){return Promise.reject(e)}},l.prototype.HandleAuthError=function(e){},l.prototype.HandleAuthCheck=function(e){try{var r=this,t=c(function(){return Promise.resolve(r.getUserLogin()).then(function(e){p("HandleAuthCheck: user is still logged in",{user:e})})},function(e){p("HandleAuthCheck: ",{e:e})});return t&&t.then?t.then(function(){}):void 0}catch(e){return Promise.reject(e)}},l.prototype.getUserLogin=function(){try{var e=this;return new Promise(function(r,t){e.auth.onAuthStateChanged(function(e){e?r(e):t("User not logged in")})})}catch(e){return Promise.reject(e)}},exports.FirebaseRealTimeSaga=function(e,t){return r(function(e,r){return function(t,n,o){if((!r||!Array.isArray(r.watch)||r.watch.includes(n))&&!(r&&Array.isArray(r.dontwatch)&&r.dontwatch.includes(n)))return{subscribe:function(r){var i=a.GetResource(n).observable.subscribe(function(){e(t,n,o).then(function(e){return r.next(e)}).catch(function(e){return r.error(e)})});return{unsubscribe:function(){i.unsubscribe()}}}}}}(e,t))},exports.FirebaseDataProvider=function(e){if(!e)throw new Error("Please pass the Firebase config.json object to the FirebaseDataProvider");return s=e.debug,a=new u(e),function(e,r,t){try{return Promise.resolve(a.initPath(r)).then(function(){switch(e){case o.GET_MANY:return a.apiGetMany(r,t);case o.GET_MANY_REFERENCE:return a.apiGetManyReference(r,t);case o.GET_LIST:return a.apiGetList(r,t);case o.GET_ONE:return a.apiGetOne(r,t);case o.CREATE:return a.apiCreate(r,t);case o.UPDATE:return a.apiUpdate(r,t);case o.UPDATE_MANY:return a.apiUpdateMany(r,t);case o.DELETE:return a.apiDelete(r,t);case o.DELETE_MANY:return a.apiDeleteMany(r,t);default:return{}}})}catch(e){return Promise.reject(e)}}},exports.FirebaseAuthProvider=function(e){if(!e)throw new Error("Please pass the Firebase config.json object to the FirebaseAuthProvider");h=e.debug;var r=new l(e);return function(e,t){try{switch(p("Auth Event: ",{type:e,params:t}),e){case o.AUTH_LOGIN:return Promise.resolve(r.HandleAuthLogin(t)).then(function(){});case o.AUTH_LOGOUT:return Promise.resolve(r.HandleAuthLogout(t)).then(function(){});case o.AUTH_ERROR:return Promise.resolve(r.HandleAuthError(t)).then(function(){});case o.AUTH_CHECK:return Promise.resolve(r.HandleAuthCheck(t)).then(function(){});default:throw new Error("Unhandled auth type:"+e)}}catch(e){return Promise.reject(e)}}};
//# sourceMappingURL=index.js.map
